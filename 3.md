Section 3
=========

~.~.~.~.~.~.~. Chapter 3. 1 ~.~.~.~.~.~.~.
---------

For OpenStack multi-node network interface ==> http://docs.openstack.org/security-guide/networking/architecture.html

If your instance do not have an IP address run command
```bash
    dhclient
```
To sync time

```bash
    apt-get install ntp
```
Check locale

```bash
    python -c 'import locale; print(locale.getdefaultlocale());'
```

In case of an error and depending on wheather you have a .bashrc run below command else replace .bashrc in it with .bash_profile  

```bash
        printf "LANG=en_US.UTF-8\nLC_ALL=en_US.UTF-8"| tee -a ~/.bashrc | source ~/.bashrc
```


```bash
apt-get install software-properties-common
```

```bash
add-apt-repository cloud-archive:liberty
```

```bash
apt-get update && apt-get dist-upgrade
```

Reboot if the update process has a new kernel

```bash
 reboot
```
```bash
 apt-get install python-openstackclient
```
```bash
 shutdown now
```

```bash
 ip a | less
```
```bash
 dhclient
```
```bash
 ssh ubuntu@10.10.10.x
```
```bash
 hostname controller
```

```bash
 hostname network
```
```bash
 hostname compute
```

On all the nodes add these host file entries, for example

```bash
 vi /etc/hosts
```

    10.10.10.2       controller
    
    10.10.10.3      network
    
    10.10.10.4       compute



```bash
 apt-get install mariadb-server python-mysqldb
```

```bash
 vi /etc/mysql/conf.d/mysqld_openstack.cnf
```

		[mysqld] 
		bind-address = 10.10.10.2
		default-storage-engine = innodb
		innodb_file_per_table
		collation-server = utf8_general_ci
		init-connect = 'SET NAMES utf8'
		character-set-server = utf8

```bash
service mysql restart
```

```bash
 apt-get install rabbitmq-server
```
```bash
 rabbitmqctl add_user openstack password
```


```bash
 rabbitmqctl set_permissions openstack ".*" ".*" ".*"
```


~.~.~.~.~.~.~. Chapter 3.2 ~.~.~.~.~.~.~. 
-------------------------------

```sql
# mysql –u root –p
```
```sql
CREATE DATABASE keystone;
```


```sql
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'password';
```
```sql
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'password';
```

```sql
exit;
```
```bash
echo "manual" > /etc/init/keystone.override
```
```bash
 apt-get install keystone 
```
```bash
apt-get install apache2 libapache2-mod-wsgi
```

```bash
 apt-get install memcached python-memcache
 ```

```bash
 apt-get install memcached python-memcache
```
```bash
 vi /etc/keystone/keystone.conf
```

    [default]
    ...
    admin_token = password
    
    [database]
    ...
    mysql+pymysql://keystone:password@controller/keystone
    
    [memcache]
    ...
    localhost:11211
    
    [token]
    ...
    provider = uuid
    driver = memcache
    
    [revoke]
    driver=sql

```bash
 su -s /bin/sh -c "keystone-manage db_sync" keystone
```

```bash
 vi /etc/apache2/apache2.conf
```
    ServerName controller

```bash
 vi /etc/apache2/sites-available/wsgi-keystone.conf
```

    Listen 5000
    Listen 35357
    
    <VirtualHost *:5000>
        WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
        WSGIProcessGroup keystone-public
        WSGIScriptAlias / /usr/bin/keystone-wsgi-public
        WSGIApplicationGroup %{GLOBAL}
        WSGIPassAuthorization On
        <IfVersion >= 2.4>
          ErrorLogFormat "%{cu}t %M"
        </IfVersion>
        ErrorLog /var/log/apache2/keystone.log
        CustomLog /var/log/apache2/keystone_access.log combined
    
        <Directory /usr/bin>
            <IfVersion >= 2.4>
                Require all granted
            </IfVersion>
            <IfVersion < 2.4>
                Order allow,deny
                Allow from all
            </IfVersion>
        </Directory>
    </VirtualHost>
    
    <VirtualHost *:35357>
        WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}
        WSGIProcessGroup keystone-admin
        WSGIScriptAlias / /usr/bin/keystone-wsgi-admin
        WSGIApplicationGroup %{GLOBAL}
        WSGIPassAuthorization On
        <IfVersion >= 2.4>
          ErrorLogFormat "%{cu}t %M"
        </IfVersion>
        ErrorLog /var/log/apache2/keystone.log
        CustomLog /var/log/apache2/keystone_access.log combined
    
        <Directory /usr/bin>
            <IfVersion >= 2.4>
                Require all granted
            </IfVersion>
            <IfVersion < 2.4>
                Order allow,deny
                Allow from all
            </IfVersion>
        </Directory>
    </VirtualHost>



```bash
 ln -s /etc/apache2/sites-available/wsgi-keystone.conf /etc/apache2/sites-enabled
```

```bash
 service apache2 restart
```

```bash
 export OS_TOKEN=password
 export OS_URL=http://controller:35357/v3
 export OS_IDENTITY_API_VERSION=3
```

```bash
 tail -f /var/log/apache2/keystone.log
 
```

```bash
 openstack service create --name keystone --description "OpenStack Identity" identity
```

```bash
 openstack endpoint create \
 --region RegionOne \ 
 identity public http://controller:5000/v2.0

 openstack endpoint create \
 --region RegionOne \
 identity internal http://controller:5000/v2.0

  openstack endpoint create \
 --region RegionOne \
  identity admin http://controller:35357/v2.0

```

```bash
 openstack project create --domain default \
 --description "Admin Project" admin
```
```bash
 openstack user create --domain default --password-prompt admin
```
```bash
 openstack role create admin
```
```bash
 openstack role add --project admin --user admin admin
```
```bash
 vi /etc/keystone/policy.json
```

```bash
 unset OS_TOKEN OS_URL
```

```bash
 vi admin.opensrc.sh 
```

    export OS_PROJECT_DOMAIN_ID=default
    export OS_USER_DOMAIN_ID=default
    export OS_PROJECT_NAME=admin
    export OS_TENANT_NAME=admin
    export OS_USERNAME=admin
    export OS_PASSWORD=password
    export OS_AUTH_URL=http://controller:35357/v3
    export OS_IDENTITY_API_VERSION=3


```bash
 source admin-openrc.sh
```

```bash
 openstack token issue
```


~.~.~.~.~.~.~. Chapter 3.3 ~.~.~.~.~.~.~. 
-------------------------------

```bash
 mysql -u root -p
```

```sql
 CREATE DATABASE glance;
 
 GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \   IDENTIFIED BY 'password';
 
 GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \   IDENTIFIED BY 'password';
 
 exit;
```

```bash
 source admin-openrc.sh
 
 openstack user create --domain default --password-prompt glance
 
 openstack role add --project service --user glance admin
```

```bash

openstack service create --name glance \   --description "OpenStack Image service" image

openstack endpoint create --region RegionOne \   image public http://controller:9292

openstack endpoint create --region RegionOne \   image internal http://controller:9292

openstack endpoint create --region RegionOne \   image admin http://controller:9292
```
```bash
 apt-get install glance python-glanceclient
 
 vi /etc/glance/glance-api.conf
```

    [database]
    ...
    connection = mysql+pymysql://glance:password@controller/glance
 
    [keystone_authtoken]
    ...
    auth_uri = http://controller:5000 
    auth_url = http://controller:35357 
    auth_plugin = password 
    project_domain_id = default 
    user_domain_id = default 
    project_name = service 
    username = glance 
    password = password

    [paste_deploy] 
    ...
    flavor = keystone

    [glance_store]
    ...
    default_store = file 
    filesystem_store_datadir = /var/lib/glance/images/

    [keystone_authtoken] 
    #Remove any options here.


```bash
  vi /etc/glance/glance-registry.conf
  ```

    [database] 
    ... 
    connection = mysql+pymysql://glance:password@controller/glance
    

    [keystone_authtoken]
    #Remove any other options in this section.
    auth_uri = http://controller:5000 
    auth_url = http://controller:35357 
    auth_plugin = password 
    project_domain_id = default 
    user_domain_id = default 
    project_name = service 
    username = glance 
    password = password
     
    [paste_deploy]
    ...
    flavor = keystone

```bash
 su -s /bin/sh -c "glance-manage db_sync" glance
```

```bash
 service glance-registry restart 
 service glance-api restart
```

```bash
 echo "export OS_IMAGE_API_VERSION=2" \   | tee -a admin-openrc.sh
 
 source admin-openrc.sh
 
 wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img 
 
 glance image-create --name "cirros" \
  --file cirros-0.3.4-x86_64-disk.img \
  --disk-format qcow2 \
  --container-format bare \
  --visibility public \
  --progress

 glance image-list
```






~.~.~.~.~.~.~. Chapter 3.4 ~.~.~.~.~.~.~. 
-------------------------------

```bash
 mysql -u root -p
```

```sql

 CREATE DATABASE nova;
 
 GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \   
 IDENTIFIED BY 'password';
  
 GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \   
 IDENTIFIED BY 'password';
 
exit;
```

```bash

 source admin-openrc.sh
 
 openstack user create --domain default --password-prompt 
 
 openstack role add --project service --user nova admin
 
 openstack service create --name nova \   
 --description "OpenStack Compute" compute
 
 openstack endpoint create --region RegionOne \   
 compute public http://controller:8774/v2/%\(tenant_id\)s
 
 openstack endpoint create --region RegionOne \   
 compute internal http://controller:8774/v2/%\(tenant_id\)s
 
 openstack endpoint create --region RegionOne \   
 compute admin http://controller:8774/v2/%\(tenant_id\)s
```

```bash
 apt-get install nova-api nova-cert nova-conductor \
 nova-consoleauth nova-novncproxy nova-scheduler \   
 python-novaclient
```

```bash
 vi /etc/nova/nova.conf 
```

    [DEFAULT]
    ...
    my_ip = 10.10.10.3
    enabled_apis=osapi_compute,metadata

    [database] 
    ... 
    connection = mysql+pymysql://nova:password@controller/nova 
    
    [DEFAULT]
    ...
    rpc_backend = rabbit
    
    [oslo_messaging_rabbit]
    ...
    rabbit_host = controller
    rabbit_userid = openstack
    rabbit_password = password
    
    [DEFAULT]
    ...
    auth_strategy = keystone
    
    [keystone_authtoken]
    ...
    auth_uri = http://controller:5000
    auth_url = http://controller:35357
    auth_plugin = password
    project_domain_id = default
    user_domain_id = default
    project_name = service
    username = nova
    password = password
    
    [DEFAULT]
    ...
    network_api_class = nova.network.neutronv2.api.API
    security_group_api = neutron
    linuxnet_interface_driver = nova.network.linux_net.NeutronLinuxBridgeInterfaceDriver
    firewall_driver = nova.virt.firewall.NoopFirewallDriver
    
    [vnc]
    ...
    vncserver_listen = $my_ip
    vncserver_proxyclient_address = $my_ip
  
    [glance]
    ...
    host = controller
    
    [oslo_concurrency]
    ...
    lock_path = /var/lib/nova/tmp
  
  
```bash
 su -s /bin/sh -c "nova-manage db sync" nova
  
  
 service nova-api restart
 
 service nova-cert restart
 
 service nova-consoleauth restart
 
 service nova-scheduler restart
 
 service nova-conductor restart
 
 service nova-novncproxy restart
 
 ```
Following are on the Control node
----------------------------------
```bash
 hostname compute
 
 vi /etc/hosts
 
 apt-get install nova-compute sysfsutils
 
 vi /etc/nova/nova.conf
 
```



    [DEFAULT]
    ...
    my_ip = MANAGEMENT_INTERFACE_IP_ADDRESS
    rpc_backend = rabbit
    
    [oslo_messaging_rabbit]
    ...
    rabbit_host = controller
    rabbit_userid = openstack
    rabbit_password = RABBIT_PASS
    
    [DEFAULT]
    ...
    auth_strategy = keystone
    
    [keystone_authtoken]
    #Remove any other options in this section
    auth_uri = http://controller:5000
    auth_url = http://controller:35357
    auth_plugin = password
    project_domain_id = default
    user_domain_id = default
    project_name = service
    username = nova
    password = password
    
    [DEFAULT]
    ...
    network_api_class = nova.network.neutronv2.api.API
    security_group_api = neutron
    linuxnet_interface_driver = nova.network.linux_net.NeutronLinuxBridgeInterfaceDriver
    firewall_driver = nova.virt.firewall.NoopFirewallDriver
    
    
    [vnc]
    ...
    enabled = True
    vncserver_listen = 0.0.0.0
    vncserver_proxyclient_address = $my_ip
    novncproxy_base_url = http://controller:6080/vnc_auto.html
    
    [glance]
    ...
    host = controller
    
    [oslo_concurrency]
    ...
    lock_path = /var/lib/nova/tmp


```bash
 egrep -c '(vmx|svm)' /proc/cpuinfo
```

If the above returns zero

```bash
 vi /etc/nova/nova-compute.conf
```

    [libvirt]
    
    ...
    
    virt_type = qemu

```bash
 service nova-compute restart
```

Now on Controller 
```bash

 source admin-openrc.sh
 
 nova service-list
 
 nova endpoints
 
 nova image-list
```





=======
~.~.~.~.~.~.~. Chapter 3. 6 ~.~.~.~.~.~.~. 
-------------------------------

On the control node

```bash
mysql –u root –p
```

```sql
CREATE DATABASE neutron; 
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' \   IDENTIFIED BY 'NEUTRON_DBPASS'; 
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' \   IDENTIFIED BY 'NEUTRON_DBPASS'; 
exit;

```

```bash
source admin-openrc.sh
openstack user create --domain default --password-prompt neutron
openstack role add --project service --user neutron admin

openstack service create --name neutron \
--description "OpenStack Networking" network


openstack endpoint create --region RegionOne \
network public http://controller:9696

openstack endpoint create --region RegionOne \
network internal http://controller:9696
  
openstack endpoint create --region RegionOne \
network admin http://controller:9696  
  
```

```bash
 apt-get install neutron-server neutron-plugin-ml2 \
  neutron-plugin-linuxbridge-agent neutron-l3-agent neutron-dhcp-agent \
  neutron-metadata-agent python-neutronclient conntrack
  
```

```bash
 cd /etc/neutron/
 mv neutron.conf neutron.conf.bkp
 wget http://venumurthy.com/neutron.conf 
```

```bash
 cd /etc/neutron/plugins/ml2/
 mv ml2_conf.ini ml2_conf.ini.bkp
 wget http://venumurthy.com/ml2_conf.ini
```


```bash
 cd /etc/neutron/plugins/ml2
 mv linuxbridge_agent.ini linuxbridge_agent.ini.bkp
 wget http://venumurthy.com/linuxbridge_agent.ini
```

```bash
 cd /etc/neutron/plugins/ml2
 mv linuxbridge_agent.ini linuxbridge_agent.ini.bkp
 wget http://venumurthy.com/linuxbridge_agent.ini
 ```

```bash
vi /etc/neutron/l3_agent.ini
```

    DEFAULT] 
    ... 
    interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver 
    external_network_bridge =

```bash
 cd /etc/neutron/
 mv dhcp_agent.ini dhcp_agent.ini.bkp
 wget http://venumurthy.com/dhcp_agent.ini
```

```bash
cd /etc/neutron/
mv metadata_agent.ini metadata_agent.ini.bkp
wget http://venumurthy.com/metadata_agent.ini
```

```bash
vi /etc/nova/nova.conf
```

    [neutron]
    ...
    url = http://controller:9696
    auth_url = http://controller:35357
    auth_plugin = password
    project_domain_id = default
    user_domain_id = default
    region_name = RegionOne
    project_name = service
    username = neutron
    password = NEUTRON_PASS
    
    service_metadata_proxy = True
    metadata_proxy_shared_secret = password

```bash
su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
```

```bash
 service nova-api restart
 
 service neutron-server restart
 service neutron-plugin-linuxbridge-agent restart
 service neutron-dhcp-agent restart
 service neutron-metadata-agent restart
 
 service neutron-l3-agent restart
```

# On compute node 

```bash
 apt-get install neutron-plugin-linuxbridge-agent conntrack
 cd /etc/neutron/
 mv neutron.conf neutron.conf.bkp
 wget http://venumurthy.com/neutron.conf 
```

```bash
service nova-compute restart
service neutron-plugin-linuxbridge-agent restart
```
===
~.~.~.~.~.~.~. Chapter 3. 7 ~.~.~.~.~.~.~. 
-------------------------------

```bash
 apt-get install openstack-dashboard
 vi /etc/openstack-dashboard/local_settings.py
```

    OPENSTACK_HOST = "controller"
    ALLOWED_HOSTS = ['*', ]
    
    #Comment out any other session storage configuration.
    CACHES = {     'default': {          'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',          'LOCATION': '127.0.0.1:11211',     } }
    
    OPENSTACK_KEYSTONE_DEFAULT_ROLE = "user"
    OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True
    OPENSTACK_API_VERSIONS = {
        "identity": 3,
        "volume": 2,
    }
    
    
    TIME_ZONE = Europe/London

```bash
service apache2 reload
```
